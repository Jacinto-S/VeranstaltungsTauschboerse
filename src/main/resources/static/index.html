<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset=" UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wochenkalender</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>


    <nav class="navbar navbar-expand-sm bg-dark sticky-top" data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Tauschbörse</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
                aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Startseite</a>
                    </li>



                </ul>
            </div>
        </div>
    </nav>

    <style>
        .week-calendar {
            display: grid;
            grid-template-columns: 50px repeat(5, 1fr);

            /* Platz für die Zeitskala */
            gap: 0px;
            max-width: 1000px;
            width: auto;
        }

        .time-scale {
            height: 600px;
            position: relative;
        }

        .time-scale div {
            position: absolute;
            width: 100%;
            font-size: 1em;
            text-align: right;
            padding-right: 10px;
        }


        .day {
            position: relative;
            padding-top: 25px;
            border-top: none;
            height: 600px;
            border: 1px solid #ccc;
        }

        .day-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            border-bottom: 1px solid #ccc;
            text-align: center;
        }

        .item-title {
            font-size: 1em;
        }

        .item {
            position: absolute;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid black;
            z-index: 1;
            overflow: hidden;
            width: 80px;
            min-width: 80px;
            font-size: 12px;
        }

        .title-line {
            margin: 0;
            border: 0;
            border-top: 1px solid black;
            width: 100%;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;

        }

        .item-subtext {
            font-size: 12px;
            opacity: 0.7;
        }
    </style>


    <div style="padding:10px;" class="container">
        <h1 id="title">Wochenkalender</h1>
        <br>
        <div class="week-calendar" id="weekCalendar"></div>

        <br>
        <button class="btn btn-primary" id="confirmOffer" style="display: none;">Angebot erstellen</button>
        <br>
        <br>

        <h2>Kalender hochladen</h2>
        <p>Bitte lade deinen Stundenplan von<br><a id="aorurl"
                href="#">https://aor.cs.hs-rm.de/plans.ics?user_plan=true</a>
            <br>als .ics Datei hoch
        </p>
        <script>
            var aorurl = document.getElementById('aorurl');
            // select text of aorurl
            aorurl.addEventListener('click', function (event) {
                event.preventDefault();
                var range = document.createRange();
                range.selectNode(aorurl);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                alert("Link wurde in die Zwischenablage kopiert");
            });

        </script>
        <div class="input-group mb-3" style="max-width: 500px;">
            <input type="file" class="form-control" id="fileupload" accept=".ics">
            <button id="submitfileupload" class="btn btn-primary" disabled>Hochladen</button>
            <span style="opacity: 0.7;font-size: small;padding-top: 5px;">Vorsicht! Beim Hochladen eines neuen Kalenders
                werden alle deine Angebote
                entfernt</span>
        </div>





        <br>
        <p>
        <div class="input-group mb-3" style="max-width: 500px;" id="MailBoxGroup">

            <input type="email" class="form-control" id="email" placeholder="email@student.hs-rm.de"> </input>
            <button id="submitemail" class="btn btn-primary">Absenden</button>
        </div>
        <script>
            var email = document.getElementById('email');
            var submitemail = document.getElementById('submitemail');
            var state = 0;
            var offer = null;
            var gesucht = [];

            var urlparams = new URLSearchParams(window.location.search);
            var logintoken = urlparams.get('logintoken');
            if (logintoken != null) {
                var url = "";
                if (isDev()) {
                    url = "http://localhost:8085/login";
                } else {
                    url = "/login";
                }
                url = url + "?logintoken=" + logintoken;
                fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                }).then(response => {
                    if (response.ok) {
                        response.text().then(data => {
                            if (data.indexOf("New") != -1) {
                                localStorage.setItem('uploadLocalCalendar', "true");
                            } else {
                                localStorage.setItem('loggedIn', "true");
                                localStorage.removeItem('tempCalendar');
                                alert("Erfolgreich eingeloggt");
                                window.location.href = "/";

                            }

                        });

                    } else {
                        window.history.replaceState({}, document.title, "/");
                    }
                });
            }



            function isDev() {
                return window.location.href.includes("localhost");
            }



            submitemail.addEventListener('click', function () {

                if (email.value.includes("@student.hs-rm.de")) {
                    var firstpart = email.value.split("@")[0];
                    if (firstpart.includes(".")) {
                        var url = "";
                        if (isDev()) {
                            url = "http://localhost:8085/requestLogin";
                        } else {
                            url = "/requestLogin";
                        }
                        url = url + "?hsMail=" + email.value;
                        submitemail.disabled = true;
                        setTimeout(function () {
                            submitemail.disabled = false;
                        }, 30000);

                        fetch(url, {
                            method: 'GET',
                            credentials: 'include'
                        }).then(response => {
                            if (response.ok) {
                                alert("Bitte prüfe dein Postfach");
                            } else {
                                alert("Fehler beim Versenden der Email");
                            }
                        });

                    } else {
                        alert("Bitte geben Sie eine gültige Studenten-Email ein");
                        return;
                    }
                } else {
                    alert("Bitte geben Sie eine gültige Studenten-Email ein");
                }

            });


        </script>
        </p>

        <br><br>

        <div class="btn-group" role="group" aria-label="Basic example">
            <button class="btn btn-warning" id="logoutbtn" style="display: none;">Ausloggen</button>
            <button class="btn btn-danger" id="removeAllOvers">Alle Angebote löschen</button>
        </div>




        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="exampleModalLabel">Herlichen Glückwunsch!</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalbody">
                        <p> Sie haben ein Angebot angenommen. </p>
                        <p> Bitte warten Sie, bis die Verarbeitung abgeschlossen ist. </p>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" id="fakeprogress" style="width: 0%;"
                                aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                        </div>




                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { Modal } from 'bootstrap';
        import * as ical from 'ical';
        window.ical = ical;

        var file = document.getElementById('fileupload');
        var submit = document.getElementById('submitfileupload');
        var removeAllOvers = document.getElementById('removeAllOvers');
        var logoutbtn = document.getElementById('logoutbtn');

        logoutbtn.addEventListener('click', function () {
            var url = "";
            if (isDev()) {
                url = "http://localhost:8085/logmeout";
            } else {
                url = "/logmeout";
            }
            fetch(url, {
                method: 'GET',
                credentials: 'include'
            }).then(response => {
                if (response.ok) {
                    localStorage.removeItem('loggedIn');

                    alert("Erfolgreich ausgeloggt");
                    window.location.reload();
                } else {
                    alert("Fehler beim Ausloggen");
                }
            });
        });


        removeAllOvers.addEventListener('click', function () {
            var url = "";
            if (isDev()) {
                url = "http://localhost:8085/removeMyOffers";
            } else {
                url = "/removeMyOffers";
            }
            fetch(url, {
                method: 'GET',
                credentials: 'include'
            }).then(response => {
                if (response.ok) {
                    alert("Alle Angebote erfolgreich gelöscht");
                    getMyCalendar();
                } else {
                    alert("Fehler beim Löschen der Angebote");
                }
            });
        });

        file.addEventListener('change', function () {
            submit.disabled = false;
        });

        function showUploadedCalendar() {

            var filedata = file.files[0];
            if (filedata.name.split('.').pop() != "ics") {
                alert("Bitte laden Sie eine .ics-Datei hoch");
                return;
            }
            submit.disabled = true;


            var reader = new FileReader();
            reader.onload = function (e) {
                var data = e.target.result;
                var url = "";
                if (isDev()) {
                    url = "http://localhost:8085/uploadKalender";
                } else {
                    url = "/uploadKalender";
                }
                if (localStorage.getItem('loggedIn') !== 'true') {
                    localStorage.setItem('tempCalendar', data);
                    showIcalCalendar(window.ical.parseICS(data));

                    return;
                }

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: data,
                    credentials: 'include'
                }).then(response => {
                    if (response.ok) {
                        alert("Kalender erfolgreich hochgeladen");
                        getMyCalendar();
                    } else {
                        alert("Fehler beim Hochladen des Kalenders");
                    }
                });

                var parsed = ical.parseICS(data);
                showIcalCalendar(parsed);
            };
            reader.readAsText(filedata);
        }
        submit.addEventListener('click', function () {
            showUploadedCalendar();
        });

        document.getElementById("confirmOffer").addEventListener('click', function () {
            if (state == 0) {
                alert("Bitte wählen Sie ein Angebot aus");
                return;
            }
            if (gesucht.length == 0) {
                alert("Bitte wählen Sie mindestens ein Gesuch aus");
                return;
            }
            var angebot = {
                "angebot": offer,
                "gesucht": gesucht
            };
            console.log(angebot);
            var offerUrl = "";
            if (isDev()) {
                offerUrl = "http://localhost:8085/createOffer";
            } else {
                offerUrl = "/createOffer";
            }

            fetch(offerUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(angebot),
                credentials: 'include'
            }).then(response => {
                if (response.ok) {
                    alert("Angebot erfolgreich erstellt");
                    state = 0;
                    offer = null;
                    gesucht = [];
                    getMyCalendar();
                } else {
                    if (response.status == 403) {
                        alert("Du darfst höchstens 2 Angebote gleichzeitig haben!");
                    } else {
                        alert("Fehler beim Erstellen des Angebots.");
                    }

                }
            });
        });

        function getMyCalendar() {
            var url = "";
            if (isDev()) {
                url = "http://localhost:8085/myKalender";
            } else {
                url = "/myKalender";
            }
            if (state == 1) {
                url += "?title=" + (offer.title.split("(")[0].trim()) + "&terminid=" + offer.offerid;
            }


            fetch(url, {
                method: 'GET',
                credentials: 'include'
            }).then(response => response.json()).then(data => {
                showCalendar(data);
            });
        }
        getMyCalendar();




        function showIcalCalendar(parsed) {
            let items = [
                [], [], [], [], []
            ];



            for (let element in parsed) {
                if (parsed.hasOwnProperty(element)) {
                    var parsedElement = parsed[element];
                    if (parsedElement.type != "VEVENT") {
                        continue;
                    }
                    var startDate = new Date(parsedElement.start);
                    var endDate = new Date(parsedElement.end);
                    var parsedStartDate = startDate.getHours() + ":" + (startDate.getMinutes() < 10 ? '0' : '') + startDate.getMinutes();
                    var parsedEndDate = endDate.getHours() + ":" + (endDate.getMinutes() < 10 ? '0' : '') + endDate.getMinutes();
                    var title = parsedElement.summary;
                    var eventtype = title.match(/\(([^)]+)\)/)[1].split("-")[0];
                    var event = {
                        title: title,
                        subtext: '',
                        color: 'lightgreen',
                        start: parsedStartDate,
                        end: parsedEndDate
                    };
                    switch (eventtype) {
                        case "V":
                            event.color = '#4961E1';
                            break;
                        case "P":
                            event.color = '#F4A460';
                            break;
                        case "Ü":
                            event.color = '#32CD32';
                            break;
                        case "S":
                            event.color = '#556B2F';
                            break;
                        default:
                            event.color = 'grey';
                    }

                    var selectDay = startDate.getDay() - 1;
                    items[selectDay].push(event);
                }
            }
            showCalendar(items);
        }
        var lastclicked = -1;

        function showCalendar(items) {
            var dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];
            const days = [{ 'Montag': [] }, { 'Dienstag': [] }, { 'Mittwoch': [] }, { 'Donnerstag': [] }, { 'Freitag': [] }];
            const startHour = 7;  // 8:00 Uhr
            const endHour = 20;   // 21:00 Uhr



            const calendarEl = document.getElementById('weekCalendar');
            calendarEl.innerHTML = '';
            function timeToPosition(time) {
                const [hours, minutes] = time.split(':').map(Number);
                const totalHours = (hours - startHour) + (minutes / 60);
                return (totalHours / (endHour - startHour)) * 100;
            }

            // Zeitskala hinzufügen
            const timeScaleEl = document.createElement('div');
            timeScaleEl.classList.add('time-scale');
            for (let hour = startHour; hour <= endHour; hour++) {
                for (let minute = 0; minute < 60; minute += 60) {
                    if (hour === startHour && minute === 0) continue;  // 8:00 überspringen
                    const timeDiv = document.createElement('div');
                    timeDiv.textContent = `${hour}:${String(minute).padStart(2, '0')}`;
                    timeDiv.style.top = `${timeToPosition(`${hour}:${minute}`)}%`;
                    timeScaleEl.appendChild(timeDiv);
                }
            }
            calendarEl.appendChild(timeScaleEl);

            var count = -1;
            days.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('day-header');
                dayHeader.textContent = dayNames[1 + count++];
                dayEl.appendChild(dayHeader);
                var samestart = 0;
                var currentstart = 0;
                const currentDay = (count);

                (items[count] || []).forEach((item, index) => {
                    const offerId = item.offerid;
                    const itemEl = document.createElement('div');
                    itemEl.classList.add('item');
                    itemEl.style.backgroundColor = item.color;

                    if (currentstart == item.start) {
                        samestart++;
                    } else {
                        samestart = 0;
                    }
                    currentstart = item.start;

                    itemEl.innerHTML = `<strong class="item-title" style="background:${item.color}">${item.title}</strong><hr class="title-line"><div class="badge text-bg-secondary">${item.subtext}</div>`;

                    itemEl.style.top = `${timeToPosition(item.start)}%`;
                    itemEl.style.height = `${timeToPosition(item.end) - timeToPosition(item.start)}%`;
                    itemEl.style.left = `${samestart * 25}px`;
                    if (lastclicked == offerId) {
                        itemEl.style.border = "5px solid #FB6D48";

                    }

                    itemEl.addEventListener('mouseover', function () {
                        itemEl.style.zIndex = 2;  // hervorheben
                    });
                    itemEl.addEventListener('mouseout', function () {
                        itemEl.style.zIndex = 1;  // zurücksetzen
                    });
                    itemEl.addEventListener('click', function () {

                        if (localStorage.getItem('loggedIn') !== 'true') {
                            alert("Bitte loggen Sie sich ein");
                            return;
                        }

                        var curday = dayNames[1 + count];
                        try {
                            var eventtype = item.title.match(/\(([^)]+)\)/)[1].split("-")[0];
                            if (eventtype == "V") {
                                return;
                            }
                        } catch (error) {

                        }
                        if (state == 1 && item.subtext.includes("OFFER") && item.subtext.indexOf("ICH") == -1) {
                            if (confirm("Willst du das Angebot annehmen: " + offerId)) {
                                var url = "";
                                if (isDev()) {
                                    url = "http://localhost:8085/acceptOffer";
                                } else {
                                    url = "/acceptOffer";
                                }
                                url = url + "?selectedTermin=" + offerId;
                                fetch(url, {
                                    method: 'GET',
                                    credentials: 'include'
                                }).then(response => {
                                    if (response.ok) {
                                        state = 0;
                                        offer = null;
                                        gesucht = [];
                                        getMyCalendar();
                                        var instance = Modal.getOrCreateInstance(document.getElementById('exampleModal'));
                                        instance.show();
                                        var fakeprogress = document.getElementById('fakeprogress');
                                        var percent = 0;
                                        var interval = setInterval(function () {
                                            percent += 1;
                                            fakeprogress.style.width = percent + "%";
                                            fakeprogress.textContent = percent + "%";
                                            if (percent >= 100) {
                                                clearInterval(interval);

                                                response.text().then(data => {
                                                    document.getElementById('modalbody').innerText = data;
                                                });
                                            }
                                        }, 75);



                                    } else {
                                        alert("Fehler beim Annehmen des Angebots");
                                    }
                                });

                            }
                            return;
                        } else if (state == 1 && item.title.indexOf("(") != -1) {

                            if (lastclicked == offerId) {
                                state = 0;
                                lastclicked = -1;
                                itemEl.style.border = "1px solid black";
                                document.getElementById('confirmOffer').style.display = "none";
                                gesucht = [];
                                offer = null;
                                getMyCalendar();
                                return;
                            }

                            state = 1;
                            gesucht = [];
                            offer = {
                                offerid: offerId,
                                title: item.title,
                                subtext: item.subtext,
                                color: item.color,
                                start: item.start,
                                end: item.end,
                                day: currentDay
                            };
                            lastclicked = offerId;


                            getMyCalendar();
                            return;
                        }

                        if (state == 0) {
                            state = 1;
                            lastclicked = offerId;
                            itemEl.style.border = "5px solid pink";
                            document.getElementById('confirmOffer').style.display = "block";
                            document.getElementById('confirmOffer').disabled = "true";
                            offer = {
                                offerid: offerId,
                                title: item.title,
                                subtext: item.subtext,
                                color: item.color,
                                start: item.start,
                                end: item.end,
                                day: currentDay
                            };
                            getMyCalendar();

                        } else if (state == 1) {


                            if (itemEl.style.border == "5px solid purple") {
                                itemEl.style.border = "1px solid black";
                                gesucht.forEach((element, index) => {
                                    if (element.day == currentDay && element.start == item.start && element.end == item.end) {
                                        gesucht.splice(index, 1);
                                    }
                                });
                            } else {
                                itemEl.style.border = "5px solid purple";

                                gesucht.push({
                                    title: offer.title,
                                    subtext: item.subtext,
                                    color: item.color,
                                    start: item.start,
                                    end: item.end,
                                    day: currentDay
                                });
                            }
                            console.log(gesucht);
                            if (gesucht.length > 0) {
                                document.getElementById('confirmOffer').disabled = false;
                            } else {
                                document.getElementById('confirmOffer').disabled = true;
                            }

                        }

                    });

                    dayEl.appendChild(itemEl);
                });

                calendarEl.appendChild(dayEl);
            });
        }

        var whoamiurl = "/";
        if (isDev()) {
            whoamiurl = "http://localhost:8085/whoami";
        } else {
            whoamiurl = "/whoami";
        }
        var loggedIn = localStorage.getItem('loggedIn') === 'true';
        var name = "";
        var whoamidata = "";


        function manageVisibility() {
            if (loggedIn) {
                loggedIn = true;
                document.getElementById('fileupload').disabled = false;
                document.getElementById('logoutbtn').style.display = "block";
                document.getElementById('MailBoxGroup').style.display = "none";
                document.getElementById('removeAllOvers').style.display = "block";
            } else {
                document.getElementById('title').innerText = "Wochenkalender (Nicht eingeloggt)";
                document.getElementById('removeAllOvers').style.display = "none";
                document.getElementById('logoutbtn').style.display = "none";
                document.getElementById('confirmOffer').style.display = "none";
            }
        }
        manageVisibility();
        fetch(whoamiurl, {
            method: 'GET',
            credentials: 'include'
        }).then(response => {
            if (response.ok) {
                response.text().then(data => {
                    if (data.includes("student.hs-rm.de")) {
                        loggedIn = true;
                        localStorage.setItem('loggedIn', "true");
                        whoamidata = data;
                        document.getElementById('title').innerText = "Wochenkalender für " + extractName(whoamidata);
                        manageVisibility();
                    } else {
                        localStorage.removeItem('loggedIn');
                        loggedIn = false;
                        manageVisibility();
                    }
                });
            }
        });

        function extractName(adress) {
            let namensTeil = adress.split("@")[0];
            let name = namensTeil.split(".");
            var givenName = name[0];
            givenName = givenName.charAt(0).toUpperCase() + givenName.slice(1);
            var familyName = name[1];
            familyName = familyName.charAt(0).toUpperCase() + familyName.slice(1);

            let parsedName = givenName + " " + familyName;
            return parsedName;
        }

        if (localStorage.getItem('tempCalendar') != null && localStorage.getItem('loggedIn') !== 'true') {
            showIcalCalendar(window.ical.parseICS(localStorage.getItem('tempCalendar')));
        } else if (localStorage.getItem('uploadLocalCalendar') === 'true') {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: data,
                credentials: 'include'
            }).then(response => {
                if (response.ok) {
                    localStorage.removeItem('uploadLocalCalendar');
                    localStorage.removeItem('tempCalendar');
                    alert("Dein Temporärer Kalender wurde erfolgreich hochgeladen");
                    getMyCalendar();
                } else {
                    alert("Fehler beim Hochladen des Kalenders");
                }
            });
        }

    </script>




    <footer style="margin-top: 500px;">
        <hr>
        <div class="container p-4 pb-0">

            <h6 class="text-uppercase">Links</h6>

            <ul class="list-unstyled mb-0">
                <li>
                    <a href="#!" class="text">Impressum</a>
                </li>
                <li>
                    <a href="#!" class="text">FAQ</a>
                </li>
                <li>
                    <a href="#!" class="text">Datenschutz</a>
                </li>
                <li>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                        <label class="form-check-label" for="flexSwitchCheckDefault">Darkmode</label>
                        <script>
                            var darkmodeActive = localStorage.getItem('darkmode') === 'true' || (!('darkmode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);

                            document.getElementsByTagName('html')[0].setAttribute('data-bs-theme', darkmodeActive ? 'dark' : 'light');
                            var darkswitch = document.getElementById('flexSwitchCheckDefault');
                            darkswitch.checked = darkmodeActive;

                            darkswitch.addEventListener('click', function () {
                                localStorage.setItem('darkmode', darkswitch.checked);
                                document.getElementsByTagName('html')[0].setAttribute('data-bs-theme', darkswitch.checked ? 'dark' : 'light');

                            });


                        </script>
                    </div>
                </li>
                <br>
            </ul>
        </div>
    </footer>



</body>

</html>